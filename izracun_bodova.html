<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFT21 - Izračun SFbodova</title>

    <script>
        function applySft21Theme() {
            try {
                const theme = localStorage.getItem('sft21_theme') || 'dark';
                if (theme === 'light') {
                    document.documentElement.classList.add('light-mode');
                } else {
                    document.documentElement.classList.remove('light-mode');
                }
                 if (window.setAnimationTheme) {
                    window.setAnimationTheme(theme);
                }
            } catch (e) { console.error('Error applying theme:', e); }
        }
        applySft21Theme();
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) { applySft21Theme(); }
        });
    </script>

    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial+Narrow&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6a1b9a; --secondary-color: #ab47bc; --accent-color: #ff00ff;
            --fluorescent-green: #80ff00; --text-color: #e5e7eb; --text-color-darker: #c7c1da;
            --background-dark: #0d0118; --card-background: rgba(106, 27, 154, 0.1); 
            --card-border: rgba(171, 71, 188, 0.3); 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; min-height: 100vh; overflow-x: hidden; overflow-y: auto; 
            background-color: transparent; 
            color: var(--text-color);
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        #network-canvas { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            pointer-events: none;
        }
        html:not(.light-mode) #network-canvas {
             background-color: #1d012e;
        }
        .page-wrapper {
            display: flex; flex-direction: column; align-items: center; 
            width: 100%; min-height: 100vh;
            padding-top: 5rem; 
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 60px;
        }
        .fixed-header-container {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 500; 
            background-color: var(--background-dark); box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .fixed-header-container .header-content { display: flex; align-items: center; justify-content: space-between; position: relative; height: 3.5rem; padding: 0 1.5rem; max-width: 1400px; margin: 0 auto; }
        .fixed-header-container .logo-container { display: flex; align-items: center; text-decoration: none; }
        .fixed-header-container #site-logo { height: 2.8rem; width: auto; margin-right: 0.75rem;}
        .fixed-header-container .logo-text-wrapper .product-name { font-size: 1.1rem; color: var(--fluorescent-green); font-weight: bold; }
        
        .option-close-button {
            position: fixed; top: 20px; right: 25px; font-size: 2.5rem;
            color: rgba(229, 231, 235, 0.7); background: none; border: none;
            cursor: pointer; transition: color 0.3s ease, transform 0.2s ease;
            z-index: 501; line-height: 1; padding: 5px;
        }
        .option-close-button:hover { color: white; transform: scale(1.1); }
        .page-main-title {
            font-family: 'Orbitron', sans-serif; font-size: clamp(1.8rem, 4vw, 2.5rem); 
            color: var(--fluorescent-green); text-align: center; 
            margin-top: 0;
            margin-bottom: 40px; text-shadow: 0 0 10px rgba(128, 255, 0, 0.5); padding: 0 15px;
        }
        .calculator-container { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 30px; }
        .form-section { background-color: var(--background-dark); border: 1px solid var(--card-border); padding: 20px; border-radius: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 15px; gap: 15px; }
        .section-title { font-size: clamp(1.1rem, 2.5vw, 1.3rem); color: var(--text-color); font-weight: bold; }
        .sfb-output-wrapper { display: flex; align-items: center; gap: 10px; }
        .sfb-output-wrapper label { font-size: 1rem; color: var(--text-color-darker); }
        .sfb-output { width: 100px; text-align: right; background: transparent; border: 1px solid var(--fluorescent-green); color: var(--fluorescent-green); padding: 8px; font-size: 1.1rem; border-radius: 5px; font-weight: bold; }
        .input-field { width: 100%; background: transparent; color: var(--text-color); border: 1px solid var(--card-border); border-radius: 5px; padding: 10px; font-size: 1rem; margin-bottom: 15px; }
        .input-field:focus { outline: none; border-color: var(--fluorescent-green); }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        .calc-button { padding: 8px 12px; font-size: 0.9rem; background-color: rgba(171, 71, 188, 0.1); border: 1px solid var(--card-border); color: var(--text-color-darker); border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
        .calc-button:hover { border-color: var(--fluorescent-green); color: var(--text-color); }
        .calc-button.selected { background-color: var(--fluorescent-green); color: #000; border-color: var(--fluorescent-green); font-weight: bold; }
        .custom-amount-wrapper { display: flex; align-items: center; gap: 10px; }
        .custom-amount-wrapper .calc-button { flex-shrink: 0; }
        .custom-amount-wrapper .input-field { margin-bottom: 0; }
        .add-button { font-size: 1.5rem; line-height: 1; padding: 2px 10px; margin-left: auto; background-color: transparent; border: 1px solid var(--fluorescent-green); color: var(--fluorescent-green); border-radius: 50%; cursor: pointer; transition: all 0.3s; }
        .add-button:hover { background-color: var(--fluorescent-green); color: #000; }
        .member-entry { border-top: 1px dashed var(--card-border); padding-top: 20px; margin-top: 20px; }
        .member-entry:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .remove-button { color: #ff4d4d; background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }
        .summary-row { display: flex; justify-content: space-around; padding: 15px 0; gap: 20px; }
        .summary-item { text-align: center; }
        .summary-item label { display: block; font-size: 1.2rem; color: var(--text-color); margin-bottom: 8px; }
        .summary-item .sfb-output { width: 150px; font-size: 1.5rem; }
        .hidden { display: none !important; }
        .initial-reserve-input-container { display: inline-block; margin-right: 10px; }
        .back-link-container { margin-top: 40px; text-align: center; }
        .back-link { font-family: 'Orbitron', sans-serif; color: var(--fluorescent-green); text-decoration: none; font-size: 1.1rem; font-weight: bold; transition: text-shadow 0.3s ease; }
        .back-link:hover { text-shadow: 0 0 10px rgba(128, 255, 0, 0.7); }
        .manual-reserve-input-container { display: inline-block; margin-left: 10px; }
        .manual-reserve-input { width: 120px; padding: 8px; font-size: 0.8rem; background: transparent; border: 1px solid var(--card-border); color: var(--text-color); border-radius: 5px; }
        .manual-reserve-input:focus { outline: none; border-color: var(--fluorescent-green); }
        .manual-reserve-input::placeholder { font-size: 0.8rem; }

        /* STILOVI ZA LIGHT MODE */
        html.light-mode body { background-color: #f8fafc !important; color: #334155 !important; }
        html.light-mode .fixed-header-container { background-color: white !important; }
        html.light-mode .fixed-header-container .logo-text-wrapper .product-name { color: var(--primary-color) !important; }
        html.light-mode .option-close-button { color: #64748b !important; }
        html.light-mode .option-close-button:hover { color: #1e293b !important; }
        html.light-mode .page-main-title { color: var(--primary-color) !important; text-shadow: none; }
        html.light-mode .form-section { background: white; border-color: #e2e8f0; }
        html.light-mode .section-title, html.light-mode .sfb-output-wrapper label { color: #1e293b; }
        html.light-mode .input-field, html.light-mode .manual-reserve-input { color: #334155; border-color: #cbd5e1; background-color: #f9fafb; }
        html.light-mode .input-field:focus, html.light-mode .manual-reserve-input:focus { border-color: var(--primary-color); }
        html.light-mode .sfb-output { border-color: var(--primary-color); color: var(--primary-color); }
        html.light-mode .calc-button { background: #f1f5f9; border-color: #e2e8f0; color: #475569; }
        html.light-mode .calc-button:hover { border-color: var(--primary-color); color: #1e293b; }
        html.light-mode .calc-button.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        html.light-mode .add-button { border-color: var(--primary-color); color: var(--primary-color); }
        html.light-mode .add-button:hover { background: var(--primary-color); color: white; }
        html.light-mode .back-link { color: var(--primary-color) !important; text-shadow: none !important; }
        html.light-mode .back-link:hover { text-decoration: underline; }
        html.light-mode #network-canvas { background-color: transparent !important; }
        html.light-mode .summary-item label { color: #4b5563 !important; }
    </style>
</head>
<body>
    <canvas id="network-canvas"></canvas>

    <div class="fixed-header-container">
        <div class="header-content">
            <a href="index.html" class="logo-container" title="Povratak na početnu stranicu">
                <img src="img/IFIG-logo.png" alt="SFT21 logo" id="site-logo">
                <div class="logo-text-wrapper">
                    <span class="product-name">SFT21</span>
                </div>
            </a>
        </div>
    </div>
    
    <button class="option-close-button" id="closeCalcButton" title="Natrag">×</button>

    <div class="page-wrapper">
        <h1 class="page-main-title">IZRAČUN SFBODOVA</h1>

        <div class="calculator-container">
            <div class="form-section">
                <input type="text" id="username" class="input-field" placeholder="KORISNIČKO IME / IME I PREZIME">
            </div>

            <div class="form-section" data-section="startPackage">
                <div class="section-header">
                    <span class="section-title">STARTNI PAKET / 1 € = 2 SFb</span>
                    <div class="sfb-output-wrapper">
                        <label for="startPackageSfb">SFbodovi</label>
                        <input type="text" id="startPackageSfb" class="sfb-output" value="0" readonly>
                    </div>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="30">30 $</button>
                    <button class="calc-button" data-value="55">55 $</button>
                    <button class="calc-button" data-value="105">105 $</button>
                    <button class="calc-button" data-value="205">205 $</button>
                    <button class="calc-button" data-value="455">455 $</button>
                    <button class="calc-button" data-value="955">955 $</button>
                    <button class="calc-button" data-value="1955">1955 $</button>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="42">42 €</button>
                    <button class="calc-button" data-value="77">77 €</button>
                    <button class="calc-button" data-value="145">145 €</button>
                    <button class="calc-button" data-value="285">285 €</button>
                    <button class="calc-button" data-value="630">630 €</button>
                    <button class="calc-button" data-value="1325">1325 €</button>
                    <button class="calc-button" data-value="2710">2710 €</button>
                </div>
                <div class="custom-amount-wrapper">
                    <button class="calc-button" data-type="custom-btn">Veći iznos</button>
                    <input type="number" class="input-field" placeholder="Upiši iznos (€)" min="0">
                </div>
            </div>

                <div class="form-section hidden" data-section="reserveWallet">
                 <div class="section-header">
                    <span class="section-title">ZARADA IZ REZERVNOG NOVČANIKA / 1 € = 1 SFb</span>
                    <div class="sfb-output-wrapper">
                        <label for="reserveWalletSfb">SFbodovi</label>
                        <input type="text" id="reserveWalletSfb" class="sfb-output" value="0" readonly>
                    </div>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="55">55 $</button>
                    <button class="calc-button" data-value="105">105 $</button>
                    <button class="calc-button" data-value="205">205 $</button>
                    <button class="calc-button" data-value="455">455 $</button>
                    <button class="calc-button" data-value="955">955 $</button>
                    <button class="calc-button" data-value="1955">1955 $</button>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="77">77 €</button>
                    <button class="calc-button" data-value="145">145 €</button>
                    <button class="calc-button" data-value="285">285 €</button>
                    <button class="calc-button" data-value="630">630 €</button>
                    <button class="calc-button" data-value="1325">1325 €</button>
                    <button class="calc-button" data-value="2710">2710 €</button>
                </div>
            </div>

            <div class="form-section" data-section="mainWallet">
                <div class="section-header">
                    <span class="section-title">IZNOS IZ NOVČANIKA / 1 € = 2 SFb</span>
                    <div class="sfb-output-wrapper">
                        <label for="mainWalletSfb">SFbodovi</label>
                        <input type="text" id="mainWalletSfb" class="sfb-output" value="0" readonly>
                    </div>
                </div>
                <input type="number" class="input-field" placeholder="Upiši iznos (€)" min="0">
            </div>

            <div class="form-section" data-section="directMembers">
                <div class="section-header">
                    <span class="section-title">50% IZNOSA STARTNOG PAKETA DIREKTNIH ČLANOVA / 1 € = 1 SFb</span>
                    <button class="add-button" id="addDirectMember">+</button>
                </div>
                <div id="directMembersContainer"></div>
            </div>
            
            <div class="form-section" data-section="indirectMembers">
                <div class="section-header">
                    <span class="section-title">25% IZNOSA STARTNOG PAKETA INDIREKTNIH ČLANOVA / 1 € = 1 SFb</span>
                    <button class="add-button" id="addIndirectMember">+</button>
                </div>
                <div id="indirectMembersContainer"></div>
            </div>

            <div class="form-section" data-section="licensePackage">
                 <div class="section-header">
                    <span class="section-title">LICENCNI PAKET / 1 € = 2 SFb</span>
                    <div class="sfb-output-wrapper">
                        <label for="licenseSfb">SFbodovi</label>
                        <input type="text" id="licenseSfb" class="sfb-output" value="0" readonly>
                    </div>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="100">100 €</button>
                    <button class="calc-button" data-value="200">200 €</button>
                    <button class="calc-button" data-value="500">500 €</button>
                    <button class="calc-button" data-value="1000">1000 €</button>
                    <button class="calc-button" data-value="1500">1500 €</button>
                    <button class="calc-button" data-value="2100">2100 €</button>
                </div>
                <div class="custom-amount-wrapper">
                    <button class="calc-button" data-type="custom-btn">Veći iznos</button>
                    <input type="number" class="input-field" placeholder="Upiši iznos (€)" min="0">
                </div>
            </div>
            
            <div class="form-section" id="summary-section">
                <div class="summary-row">
                    <div class="summary-item">
                        <label for="totalSfb">UKUPNO SFBODOVA</label>
                        <input type="text" id="totalSfb" class="sfb-output" value="0" readonly>
                    </div>
                    <div class="summary-item">
                        <label for="limitSfc">LIMIT ZARADE</label>
                        <input type="text" id="limitSfc" class="sfb-output" value="0" readonly>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="back-link-container">
            <a href="#" id="backLink" class="back-link">VRATI SE</a>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('network-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const darkOptions = { particleColorRGB: '128, 255, 0', lineColorRGB: '170, 0, 255', particleAmount: 120, defaultRadius: 1.3, linkRadius: 150, particleSpeed: 0.25, lineWidth: 0.4 };
            const lightOptions = { particleColorRGB: '106, 27, 154', lineColorRGB: '171, 71, 188', particleAmount: 120, defaultRadius: 1.3, linkRadius: 150, particleSpeed: 0.25, lineWidth: 0.4 };
            let currentOptions = document.documentElement.classList.contains('light-mode') ? lightOptions : darkOptions;

            const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); };
            window.addEventListener('resize', resizeCanvas);

            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                    this.radius = currentOptions.defaultRadius;
                    this.vx = (Math.random() - 0.5) * currentOptions.particleSpeed;
                    this.vy = (Math.random() - 0.5) * currentOptions.particleSpeed;
                }
                draw() {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${currentOptions.particleColorRGB}, 0.85)`; ctx.fill();
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    if (this.x > canvas.width || this.x < 0) this.vx = -this.vx;
                    if (this.y > canvas.height || this.y < 0) this.vy = -this.vy;
                }
            }

            const initParticles = () => {
                particles = [];
                for (let i = 0; i < currentOptions.particleAmount; i++) { particles.push(new Particle()); }
            };
            const animate = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            };

            window.setAnimationTheme = (theme) => {
                currentOptions = (theme === 'light') ? lightOptions : darkOptions;
                if(canvas.width > 0) initParticles();
            };
            
            resizeCanvas();
            animate();

            const logoImage = document.getElementById('site-logo');
            const applyLogoTheme = () => {
                const isLight = document.documentElement.classList.contains('light-mode');
                if (logoImage) { logoImage.src = isLight ? 'img/IFIG-logo_purple.png' : 'img/IFIG-logo.png'; }
            };
            applyLogoTheme();
            
            // Re-check theme on pageshow, especially for bf-cache
             window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    applyLogoTheme();
                }
            });
        });
    </script>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- NAVIGACIJA ---
        const closeButton = document.getElementById('closeCalcButton');
        const backLink = document.getElementById('backLink');
        if (closeButton) { closeButton.addEventListener('click', () => window.history.back()); }
        if (backLink) { backLink.addEventListener('click', (e) => { e.preventDefault(); window.history.back(); }); }
        
        // --- GLOBALNE VARIJABLE ---
        let currentStartPackageValue = 0;
        let reserveBaseValue = 0; 
        
        const reserveWalletSection = document.querySelector('[data-section="reserveWallet"]');
        const reserveWalletButtons = reserveWalletSection.querySelectorAll('.calc-button');
        const startPackageSection = document.querySelector('[data-section="startPackage"]');
        
        // --- GLAVNE FUNKCIJE ---
        const calculateTotal = () => {
            let totalSfb = 0;
            document.querySelectorAll('.sfb-output').forEach(output => {
                const value = parseFloat(output.value) || 0;
                if (output.id !== 'totalSfb' && output.id !== 'limitSfc') { totalSfb += value; }
            });
            document.getElementById('totalSfb').value = totalSfb.toFixed(2);
            const roundedLimit = Math.ceil(totalSfb / 50) * 50;
            const finalLimit = Math.min(roundedLimit, 2100);
            document.getElementById('limitSfc').value = finalLimit;
        };

        // --- KONAČNI ISPRAVAK JE OVDJE ---
        // Ova funkcija sada ispravno računa SFbodove kao razliku ili kao direktan unos.
        const calculateReserveSfb = () => {
            const activeManualInput = document.querySelector('.manual-reserve-input, .initial-reserve-input-container input');
            const manualValue = activeManualInput ? (parseFloat(activeManualInput.value) || 0) : 0;
            
            let sfbPoints = 0;

            if (reserveBaseValue > 0) {
                // Slučaj 1: Odabran je osnovni gumb (npr. 55$, 105$).
                // SFbodovi su razlika između te vrijednosti i startnog paketa, plus eventualna ručna doplata.
                sfbPoints = (reserveBaseValue - currentStartPackageValue) + manualValue;
            } else {
                // Slučaj 2: Nije odabran osnovni gumb.
                // Korisnik unosi iznos u početno polje. SFbodovi su jednaki tom iznosu.
                sfbPoints = manualValue;
            }
            
            // Osiguravamo da bodovi ne budu negativni i upisujemo ih u polje.
            document.getElementById('reserveWalletSfb').value = Math.max(0, sfbPoints).toFixed(2);
            calculateTotal();
        };
        
        const updateReserveWalletVisibility = (startValue, startCurrency) => {
            document.querySelectorAll('.initial-reserve-input-container, .manual-reserve-input-container').forEach(el => el.remove());
            reserveWalletButtons.forEach(btn => btn.classList.remove('selected'));
            reserveBaseValue = 0;
            calculateReserveSfb();

            if (startValue === 0) {
                reserveWalletSection.classList.add('hidden');
                return;
            }

            const thresholds = {
                '$': [55, 105, 205, 455, 955, 1955],
                '€': [77, 145, 285, 630, 1325, 2710]
            };
            const currentThresholds = thresholds[startCurrency] || [];

            let showFromValue = currentThresholds[0] || 999999;
            for (let i = 0; i < currentThresholds.length; i++) {
                if (startValue < currentThresholds[i]) {
                    showFromValue = currentThresholds[i];
                    break;
                }
                if (i === currentThresholds.length - 1) { showFromValue = 999999; }
            }

            let anyVisible = false;
            let firstVisibleButton = null;
            reserveWalletButtons.forEach(button => {
                const buttonValue = parseFloat(button.dataset.value);
                const buttonCurrency = button.textContent.includes('$') ? '$' : '€';
                const isVisible = buttonValue >= showFromValue && buttonCurrency === startCurrency;
                button.classList.toggle('hidden', !isVisible);

                if (isVisible) {
                    anyVisible = true;
                    if (!firstVisibleButton) { firstVisibleButton = button; }
                }
            });
            
            reserveWalletSection.classList.toggle('hidden', !anyVisible);

            if (firstVisibleButton) {
                const firstButtonValue = parseFloat(firstVisibleButton.dataset.value);
                const maxValue = firstButtonValue - startValue - 1;
                
                if (maxValue < 0) return;

                const inputContainer = document.createElement('span');
                inputContainer.className = 'initial-reserve-input-container';
                const manualReserveInput = document.createElement('input');
                manualReserveInput.type = 'number';
                manualReserveInput.className = 'manual-reserve-input';
                manualReserveInput.placeholder = `Upiši do ${maxValue}${startCurrency}`;
                manualReserveInput.max = maxValue;

                manualReserveInput.addEventListener('input', () => {
                    reserveWalletButtons.forEach(btn => btn.classList.remove('selected'));
                    
                    let enteredValue = parseFloat(manualReserveInput.value) || 0;
                    if (enteredValue > maxValue) {
                        enteredValue = maxValue;
                        manualReserveInput.value = maxValue;
                    }
                    reserveBaseValue = 0; // Resetiramo bazu jer se koristi samo ručni unos
                    calculateReserveSfb(); 
                });
                
                firstVisibleButton.parentNode.insertBefore(inputContainer, firstVisibleButton);
                inputContainer.appendChild(manualReserveInput);
            }
        };

        const handleGenericSection = (section, multiplier) => {
            const buttons = section.querySelectorAll('.calc-button:not([data-type="custom-btn"])');
            const customBtn = section.querySelector('.calc-button[data-type="custom-btn"]');
            const customInput = section.querySelector('.custom-amount-wrapper .input-field');
            const outputField = section.querySelector('.sfb-output');

            const update = (value) => {
                outputField.value = (value * multiplier).toFixed(2);
                calculateTotal();
            }

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    if (customBtn) customBtn.classList.remove('selected');
                    button.classList.add('selected');
                    if (customInput) customInput.value = '';
                    update(parseFloat(button.dataset.value) || 0);
                });
            });

            if (customInput) {
                const handleCustom = () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    if (customBtn) customBtn.classList.add('selected');
                    update(parseFloat(customInput.value) || 0);
                };
                customInput.addEventListener('input', handleCustom);
                if (customBtn) customBtn.addEventListener('click', () => { customInput.focus(); handleCustom(); });
            }
            if(section.dataset.section === "mainWallet") {
                section.querySelector('.input-field').addEventListener('input', (e) => {
                    update(parseFloat(e.target.value) || 0);
                });
            }
        };
        
        startPackageSection.querySelectorAll('.calc-button').forEach(button => {
            button.addEventListener('click', () => {
                startPackageSection.querySelectorAll('.calc-button').forEach(b => b.classList.remove('selected'));
                button.classList.add('selected');

                const value = parseFloat(button.dataset.value) || 0;
                const currency = button.textContent.includes('$') ? '$' : '€';
                currentStartPackageValue = value;
                startPackageSection.querySelector('.sfb-output').value = (value * 2).toFixed(2);
                
                if(button.dataset.type !== 'custom-btn') {
                   startPackageSection.querySelector('.custom-amount-wrapper .input-field').value = '';
                }

                updateReserveWalletVisibility(currentStartPackageValue, currency);
                // Ponovno izračunaj rezervu u slučaju da je već nešto bilo odabrano
                calculateReserveSfb();
                calculateTotal();
            });
        });
        startPackageSection.querySelector('.custom-amount-wrapper .input-field').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value) || 0;
            currentStartPackageValue = value;
            startPackageSection.querySelector('.sfb-output').value = (value * 2).toFixed(2);
            updateReserveWalletVisibility(currentStartPackageValue, '€');
            // Ponovno izračunaj rezervu u slučaju da je već nešto bilo odabrano
            calculateReserveSfb();
            calculateTotal();
        });

        reserveWalletButtons.forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.initial-reserve-input-container, .manual-reserve-input-container').forEach(el => el.remove());
                reserveWalletButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                reserveBaseValue = parseFloat(button.dataset.value) || 0;

                let maxValue = Infinity;
                const nextButton = button.nextElementSibling;
                const isLastButton = !nextButton || !nextButton.classList.contains('calc-button');

                if (!isLastButton) {
                    const nextValue = parseFloat(nextButton.dataset.value);
                    if (!isNaN(nextValue)) { maxValue = (nextValue - reserveBaseValue) - 1; }
                
                    const inputContainer = document.createElement('span');
                    inputContainer.className = 'manual-reserve-input-container';
                    const manualReserveInput = document.createElement('input');
                    manualReserveInput.type = 'number';
                    manualReserveInput.className = 'manual-reserve-input';
                    const currency = button.textContent.includes('$') ? '$' : '€';
                    manualReserveInput.placeholder = isFinite(maxValue) ? `Dodaj do ${maxValue}${currency}` : `Dodaj iznos (${currency})`;
                    if (isFinite(maxValue)) { manualReserveInput.max = maxValue; }
                    
                    manualReserveInput.addEventListener('input', () => {
                        if (isFinite(maxValue) && parseFloat(manualReserveInput.value) > maxValue) {
                            manualReserveInput.value = maxValue;
                        }
                        calculateReserveSfb();
                    });
                    
                    inputContainer.appendChild(manualReserveInput);
                    button.insertAdjacentElement('afterend', inputContainer);
                    manualReserveInput.focus();
                }
                
                calculateReserveSfb();
            });
        });

        handleGenericSection(document.querySelector('[data-section="licensePackage"]'), 2);
        handleGenericSection(document.querySelector('[data-section="mainWallet"]'), 2);
        
        let directMemberCounter = 0;
        let indirectMemberCounter = 0;
        const createMemberEntry = (type, counter) => {
            const entry = document.createElement('div');
            entry.className = 'member-entry';
            const multiplierValue = type === 'direct' ? 0.5 : 0.25;
            entry.innerHTML = `
                <div class="section-header">
                     <input type="text" class="input-field" placeholder="# ${counter}. KORISNIČKO IME / Ime i prezime">
                     <div class="sfb-output-wrapper"><input type="text" class="sfb-output" value="0" readonly></div>
                     <button class="remove-button" title="Ukloni člana">&times;</button>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="30">30 $</button> <button class="calc-button" data-value="55">55 $</button> <button class="calc-button" data-value="105">105 $</button> <button class="calc-button" data-value="205">205 $</button> <button class="calc-button" data-value="455">455 $</button> <button class="calc-button" data-value="955">955 $</button> <button class="calc-button" data-value="1955">1955 $</button>
                </div>
                <div class="button-group">
                    <button class="calc-button" data-value="42">42 €</button> <button class="calc-button" data-value="77">77 €</button> <button class="calc-button" data-value="145">145 €</button> <button class="calc-button" data-value="285">285 €</button> <button class="calc-button" data-value="630">630 €</button> <button class="calc-button" data-value="1325">1325 €</button> <button class="calc-button" data-value="2710">2710 €</button>
                </div>
                <div class="custom-amount-wrapper">
                    <button class="calc-button" data-type="custom-btn">Veći iznos</button>
                    <input type="number" class="input-field" placeholder="Upiši iznos (€)" min="0">
                </div>
            `;
            
            handleGenericSection(entry, multiplierValue);
            entry.querySelector('.remove-button').addEventListener('click', () => { entry.remove(); calculateTotal(); });
            return entry;
        };
        document.getElementById('addDirectMember').addEventListener('click', () => {
            directMemberCounter++;
            document.getElementById('directMembersContainer').appendChild(createMemberEntry('direct', directMemberCounter));
        });
        document.getElementById('addIndirectMember').addEventListener('click', () => {
            indirectMemberCounter++;
            document.getElementById('indirectMembersContainer').appendChild(createMemberEntry('indirect', indirectMemberCounter));
        });

        reserveWalletSection.classList.add('hidden');
        document.getElementById('addDirectMember').click();
        document.getElementById('addIndirectMember').click();
    });
</script>
</body>
</html>