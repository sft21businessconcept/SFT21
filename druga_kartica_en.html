<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFT21 - Decision: Active Member with Investment</title>

    <!-- ============================================= -->
    <!-- UNIVERSAL THEME INITIALIZATION SCRIPT -->
    <!-- ============================================= -->
    <script>
        function applySft21Theme() {
            try {
                const theme = localStorage.getItem('sft21_theme') || 'dark';
                if (theme === 'light') {
                    document.documentElement.classList.add('light-mode');
                } else {
                    document.documentElement.classList.remove('light-mode');
                }
                 if (window.setAnimationTheme) {
                    window.setAnimationTheme(theme);
                }
            } catch (e) {
                console.error('Error applying theme:', e);
            }
        }
        applySft21Theme();
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                applySft21Theme();
            }
        });
    </script>

    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Arial+Narrow&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6a1b9a; 
            --secondary-color: #ab47bc; 
            --accent-color: #ff00ff; 
            --fluorescent-green: #80ff00; 
            --fluorescent-yellow: #ccff00;
            --text-color: #e5e7eb; 
            --background-dark: #0d0118; 
            --card-background: rgba(106, 27, 154, 0.1); 
            --card-border: rgba(171, 71, 188, 0.3); 
            --button-confirm-bg: #c0392b; 
            --button-confirm-hover-bg: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; min-height: 100vh; overflow-x: hidden; overflow-y: auto;
            background-color: var(--background-dark); color: var(--text-color);
            font-family: 'Arial Narrow', Arial, sans-serif; 
        }

        .page-wrapper { display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; min-height: 100vh; width: 100%; }
        .fixed-header-container { position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background-color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .fixed-header-container .header-content { display: flex; align-items: center; justify-content: center; position: relative; height: 3.5rem; padding-left: 1.5rem; padding-right: 4rem; max-width: 100%; margin: 0 auto; }
        .fixed-header-container .header-title { font-family: 'Arial Narrow', Arial, sans-serif; font-size: clamp(1.1rem, 2.5vw, 1.5rem); color: var(--fluorescent-green); font-weight: bold; text-align: center; text-transform: uppercase; }
        .page-close-button { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); font-size: 2.2rem; color: var(--fluorescent-green); background: none; border: none; cursor: pointer; transition: color 0.3s ease, transform 0.2s ease; line-height: 1; padding: 5px; }
        .page-close-button:hover { color: white; transform: scale(1.1) translateY(-50%); }

        .decision-content-box {
            background-color: var(--card-background); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border); color: var(--text-color); width: 90%; max-width: 900px; 
            margin-top: calc(3.5rem + 30px); padding: clamp(20px, 4vw, 40px); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); font-size: clamp(0.9rem, 1.8vw, 1.05rem); line-height: 1.65;
        }

        .decision-content-box .main-greeting {
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-size: clamp(1.1rem, 2.2vw, 1.4rem);
            color: white; 
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .intro-section { text-align: center; } 
        .intro-section p { color: var(--fluorescent-yellow); margin-bottom: 12px; font-size: 1em; }
        .intro-section p.important, .intro-section p strong { font-weight: bold; color: var(--fluorescent-yellow); }
        
        .decision-content-box .highlighted-choice-title { font-size: clamp(1rem, 2vw, 1.3rem); color: var(--fluorescent-yellow); margin-top: 30px; margin-bottom: 20px; font-weight: bold; text-align: center; }
        .decision-content-box .highlighted-choice-title::before { content: "↪ "; color: var(--fluorescent-yellow); }      
        .decision-content-box .detailed-text p { margin-bottom: 15px; text-align: justify; color: white; }
        .decision-content-box .detailed-text strong, .decision-content-box .detailed-text b { color: var(--fluorescent-green); font-weight: bold; }
        .decision-content-box .detailed-text .sf-bodovi-star { color: white; font-size: 0.9em; margin-right: 5px; }

        .confirm-button-container { text-align: center; margin-top: 35px; }
        .confirm-main-page-button { background-color: var(--button-confirm-bg); color: white; padding: 12px 30px; border: none; border-radius: 5px; font-family: 'Arial Narrow', Arial, sans-serif; font-size: clamp(1rem, 2vw, 1.2rem); font-weight: bold; text-transform: uppercase; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2), 0 0 15px rgba(194, 0, 0, 0.2); }
        .confirm-main-page-button:hover { background-color: var(--button-confirm-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 25px rgba(194, 0, 0, 0.4); }

        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 20px; }
        .modal-content {
            background-color: var(--background-dark); color: var(--text-color); padding: clamp(20px, 4vw, 40px);
            border: 2px solid var(--fluorescent-green); border-radius: 15px; width: 100%; max-width: 600px;
            position: relative; box-shadow: 0 0 25px rgba(128, 255, 0, 0.3); animation: fadeIn 0.3s ease-out;
            display: flex; flex-direction: column; max-height: calc(100vh - 40px);
        }
        .modal-scrollable-content { overflow-y: auto; padding-right: 15px; margin-right: -15px; padding-left: 15px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-close-button {
            color: var(--fluorescent-green); position: absolute; top: 10px; right: 15px;
            font-size: 2.5rem; font-weight: bold; cursor: pointer; z-index: 10; transition: color 0.3s, transform 0.3s;
        }
        .modal-close-button:hover, .modal-close-button:focus { color: #fff; transform: scale(1.1); }
        .modal-content .popup-title {
            color: var(--fluorescent-green); text-align: center; font-size: clamp(1.2rem, 2.5vw, 1.6rem);
            font-weight: bold; text-transform: uppercase; margin-bottom: 20px; padding-top: 10px;
        }
        .modal-content .form-group { margin-bottom: 15px; }
        .modal-content .form-group label {
            display: block; color: var(--fluorescent-green); text-align: center; text-transform: uppercase;
            margin-bottom: 8px; font-size: 0.9rem; font-weight: bold;
        }
        .modal-content input[type="text"], .modal-content input[type="email"] {
            width: 100%; padding: 12px; border: 1px solid var(--fluorescent-green); border-radius: 4px; box-sizing: border-box;
            font-size: 1rem; background-color: rgba(0,0,0,0.2); color: var(--text-color); text-align: center;
        }
        .modal-content input::placeholder { color: #888; }
        .modal-content .email-subtitle { margin-top: 5px; margin-bottom: 8px; font-size: 0.85rem; color: #ccc; text-align: center; }
        .modal-content .napomena {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--card-border);
            font-size: 0.85rem; line-height: 1.5; color: #bbb; text-align: left;
        }
        .modal-content .napomena p { color: #bbb; margin-bottom: 0.3em; text-align: justify; }
        .modal-content .napomena strong { color: var(--fluorescent-yellow); }
        .error-message { color: #ff4d4d; font-size: 0.85rem; height: 1.2em; margin-top: 5px; text-align: center; }
        .input-error { border-color: #ff4d4d !important; box-shadow: 0 0 8px rgba(255, 77, 77, 0.7); }

        .modal-content .investment-title {
            color: var(--fluorescent-green); text-align: center; text-transform: uppercase;
            font-weight: bold; margin-top: 30px; margin-bottom: 15px; font-size: 1rem;
        }
        .investment-package-field-container {
            width: 100%; padding: 15px; border: 1px solid var(--fluorescent-green); border-radius: 8px;
            background-color: rgba(106, 27, 154, 0.1); box-sizing: border-box; margin-top: 0.5rem; margin-bottom: 1rem; 
        }
        .package-item { display: flex; align-items: center; padding: 0.4rem 0.25rem; }
        .package-item input[type="checkbox"] { margin-right: 0.75rem; transform: scale(1.2); accent-color: var(--fluorescent-green); flex-shrink: 0; cursor: pointer; }
        .package-label { color: #e0e0e0; cursor: pointer; font-size: 0.9rem; line-height: 1.4; flex-grow: 1; }
        .form-input-ip7 {
            width: 100px; padding: 6px 8px; border: 1px solid var(--fluorescent-green); border-radius: 5px;
            background-color: rgba(106, 27, 154, 0.15); color: white; font-size: 0.9rem; text-align: right; margin-left: auto;
        }
        .form-input-ip7:disabled { background-color: rgba(106, 27, 154, 0.05); cursor: not-allowed; border-color: rgba(128, 255, 0, 0.2); }
        .total-investment-display { font-size: 1.1rem; font-weight: bold; text-align: center; color: var(--fluorescent-yellow); margin: 20px 0 10px 0; }
        #investmentErrorPopup { color: #ff4d4d; text-align: center; height: 1.2em; margin-top: -10px; }

        .modal-confirm-button {
            display: block; margin: 20px auto 0; padding: 12px 35px; font-size: 1.1rem; font-weight: bold;
            text-transform: uppercase; color: var(--background-dark); background-color: var(--fluorescent-green);
            border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease;
        }
        .modal-confirm-button:hover:not(:disabled) { background-color: #fff; transform: translateY(-2px); }
        .modal-confirm-button:disabled { background-color: #586351; color: #999; opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .final-popup-title { font-size: clamp(1.4rem, 3vw, 1.8rem) !important; }
        #final-confirmation-message { text-align: center; line-height: 1.6; font-size: 1.1rem; }
        #final-confirmation-message b { color: var(--fluorescent-yellow); }

        #network-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
    </style>
    <!-- ============================================= -->
    <!-- STYLES FOR LIGHT MODE (KONAČNA VERZIJA) -->
    <!-- ============================================= -->
    <style>
        html.light-mode body { background-color: #f8fafc !important; color: #334155 !important; }
        html.light-mode .fixed-header-container { background-color: var(--primary-color) !important; }
        html.light-mode .header-title, html.light-mode .page-close-button { color: var(--fluorescent-green) !important; }
        html.light-mode .page-close-button:hover { color: white !important; }
        
        /* Glavni kontenjer */
        html.light-mode .decision-content-box { background-color: #ffffff !important; border-color: #e2e8f0 !important; box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important; }
        
        /* Općeniti tekst */
        html.light-mode .main-greeting, html.light-mode .detailed-text p, html.light-mode .detailed-text ul, html.light-mode .intro-section p { 
            color: #334155 !important; 
        }

        /* Podebljani tekst (zeleni u dark modu) */
        html.light-mode .detailed-text strong, html.light-mode .detailed-text b { 
            color: var(--primary-color) !important; 
        }
        
        /* Istaknuti tekst (žuti u dark modu) */
        html.light-mode .intro-section p.important,
        html.light-mode .intro-section p strong,
        html.light-mode .highlighted-choice-title {
             color: #842a9d !important; 
        }

        /* Strelica */
        html.light-mode .highlighted-choice-title::before { 
            color: #842a9d !important;
        }

        /* Ikone u listama */
        html.light-mode .detailed-text .sf-bodovi-star { 
            color: var(--primary-color) !important; 
        }

        /* Gumbi i popup */
        html.light-mode .confirm-main-page-button { background-color: #dc2626 !important; }
        html.light-mode .confirm-main-page-button:hover { background-color: #ef4444 !important; }
        html.light-mode .modal-content { background-color: #ffffff; border-color: var(--primary-color); }
        html.light-mode .modal-close-button, html.light-mode .popup-title, html.light-mode .form-group label, html.light-mode .investment-title { color: var(--primary-color); }
        html.light-mode .modal-close-button:hover { color: #333; }
        html.light-mode input[type="text"], html.light-mode input[type="email"], html.light-mode input[type="number"] { background-color: #f1f5f9; border-color: #cbd5e1; color: #1e293b; }
        html.light-mode input::placeholder { color: #94a3b8; }
        html.light-mode .email-subtitle, html.light-mode .napomena p { color: #475569; }
        html.light-mode .napomena strong, html.light-mode #final-confirmation-message b { color: var(--primary-color); }
        html.light-mode .modal-confirm-button { background-color: var(--primary-color); color: white; }
        html.light-mode .modal-confirm-button:hover:not(:disabled) { background-color: var(--secondary-color); }
        html.light-mode #network-canvas { background-color: transparent !important; }
        html.light-mode .investment-package-field-container { background-color: #f8fafc; border-color: #e2e8f0; }
        html.light-mode .package-label { color: #334155; }
        html.light-mode .total-investment-display { color: #842a9d; }
    </style>
</head>
<body>
    <canvas id="network-canvas"></canvas>

    <div class="fixed-header-container">
        <div class="header-content">
            <span class="header-title">SFT21 - Decision on Business Continuation</span>
            <button class="page-close-button" id="closePageButton" title="Back to previous page">×</button>
        </div>
    </div>

    <div class="page-wrapper">
        <div class="decision-content-box">
            <p class="main-greeting">CONGRATULATIONS AND THANK YOU FOR YOUR DECISION TO JOIN US IN CONTINUING BUSINESS ACCORDING TO THE RULES OF THE NEW BUSINESS SYSTEM</p>
            
            <div class="intro-section">
                <p>Given the changes in the business model and the distribution of funds, <br><strong class="important">The Franchise Agreement you previously signed is no longer valid.</strong></p>
                <p>You will sign a new Franchise Agreement after activating a new Starter Package.</p>
                <p>Considering you started your business in the old system with <strong><span id="dynamicStartPackageInfo"></span></strong> and have decided that;</p>
            </div>
            
            <h2 class="highlighted-choice-title">
                YOU WISH to continue as an ACTIVE member, <br>(SFAlicensee)
            </h2>
            
            <div class="intro-section">
                 <p id="dynamicInvestmentReductionInfo" class="important" style="font-size: 1.1em; margin-top: -10px; margin-bottom: 25px;"></p>
            </div>
            
            <div class="detailed-text">
                <p id="dynamicContinuationInfo">You continue your business as an <strong>ACTIVE</strong> member, (<strong>SFAlicensee/starter</strong> - if you have less than 1450 SFpoints, or <strong>SFAlicensee/franchisee</strong> - if you have more than 1450 SFpoints), by opening a <strong>license user account with the "SPfree"</strong> starter package.</p>
                <p id="dynamicPaymentSFbInfoContainer">Based on the payment of <strong><span class="dynamic-old-system-payment-amount"></span></strong> for the Starter Package from the old system, you receive <strong><span class="dynamic-old-system-sf-points"></span> personal SFpoints</strong> which are transferred to the new system, plus the personal points you receive by purchasing a License Package, where for every <strong>1 <span class="dynamic-investment-currency">€</span> you get 2 SFb</strong>.</p>
                <p><span class="sf-bodovi-star">❖</span> <strong>Group SFpoints</strong> are obtained by adding the sum of the personal SFpoints of your direct and indirect members, who are also continuing their business, to your personal SFpoints. Accordingly, 50% of the total personal SFpoints of your direct members and 25% of the total personal SFpoints of their direct members (your indirect members) are added to your SFpoints. If you upgraded your account in the old system, the earnings from the reserve wallet are added to your number of SFpoints, such that for every 1 SFC, you get 1 SFb. If you had a certain amount of SFC in your wallet, that amount is also counted towards your SFpoints, with 1 SFC equaling 2 SFb.</p>
                <p id="dynamicEarningsInfo"><span class="sf-bodovi-star">❖</span> The <strong>Maximum Earnings Limit (MEL)</strong> you can receive in one accounting period will be determined by the sum of SFpoints from the old system and the SFpoints obtained by purchasing a License Package.</p>
            </div>
            
            <div class="confirm-button-container">
                <button class="confirm-main-page-button" id="openPopupForConfirmation">CONFIRM SELECTION</button>
            </div>
        </div>
    </div>

    <div id="confirmationUserDetailsPopup" class="modal-overlay">
        <div class="modal-content">
             <span id="closeUserDetailsPopupButton" class="modal-close-button" title="Close">×</span>
            <h2 class="popup-title">CONFIRM YOUR DATA</h2>
            <div class="modal-scrollable-content">
                <div class="form-group">
                    <label for="usernameInputPopup">Username</label>
                    <input type="text" id="usernameInputPopup" maxlength="21" placeholder="Your username from the old system">
                </div>
                <div class="form-group">
                    <label for="oldEmailInputPopup">Email Address</label>
                     <p class="email-subtitle">(the one you registered with in the old system)</p>
                    <input type="email" id="oldEmailInputPopup" placeholder="Old email address">
                    <div id="oldEmailErrorPopup" class="error-message"></div>
                </div>
                <div class="form-group">
                     <label for="newEmailInputPopup">New Email Address (optional)</label>
                    <p class="email-subtitle">If you no longer use or have access to your old address, please enter a new one.</p>
                    <input type="email" id="newEmailInputPopup" placeholder="New email address">
                    <div id="newEmailErrorPopup" class="error-message"></div>
                </div>
                <h5 class="investment-title">CHOOSE A LICENSE PACKAGE (OR MORE) / INVESTMENT AMOUNT</h5>
                <div class="investment-package-field-container">
                    <div class="package-item"><input type="checkbox" id="ip1-details" name="ip_package_details" value="100"><label for="ip1-details" class="package-label">First License Package (LP1): 100 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip2-details" name="ip_package_details" value="200"><label for="ip2-details" class="package-label">Second License Package (LP2): 200 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip3-details" name="ip_package_details" value="500"><label for="ip3-details" class="package-label">Third License Package (LP3): 500 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip4-details" name="ip_package_details" value="1000"><label for="ip4-details" class="package-label">Fourth License Package (LP4): 1000 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip5-details" name="ip_package_details" value="1500"><label for="ip5-details" class="package-label">Fifth License Package (LP5): 1500 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip6-details" name="ip_package_details" value="2100"><label for="ip6-details" class="package-label">Sixth License Package (LP6): 2100 €</label></div>
                    <div class="package-item"><input type="checkbox" id="ip7-checkbox-details" name="ip_package_cb_7_details"><label for="ip7-checkbox-details" class="package-label">Seventh License Package (LP7):</label><input type="number" id="ip7-custom-amount-details" name="ip7_amount_details" placeholder="Min. 5000" class="form-input-ip7" min="5000" step="100" disabled></div>
                </div>
                <p class="total-investment-display">I intend to invest a total of: <span id="total-investment-amount-details">0</span> €</p>
                <div id="investmentErrorPopup" class="error-message"></div>
                <div class="napomena">
                    <strong>Note:</strong>
                    <p>This step is for the preliminary collection of data regarding members' interest. After confirmation, you will receive further instructions via email regarding the method and timing of the investment payment. Your decision here is not financially binding until you make the payment according to the official instructions.</p>
                    <p>The continuation of business operations will begin with the first filling of the SFalgorithm, about which you will be timely notified via email.</p>
                </div>
            </div>
            <button id="confirmUserDetailsButton" class="modal-confirm-button">Confirm</button>
        </div>
    </div>
    
    <div id="finalConfirmationPopup" class="modal-overlay">
        <div class="modal-content">
            <span id="closeFinalConfirmationPopup" class="modal-close-button" title="Close">×</span>
            <h2 class="popup-title final-popup-title">Information</h2>
            <p id="final-confirmation-message"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyhhosQJfFDf8-_jLkLeycTECYUWaUBiaEMuS7kSGKiDkTVHuaPIwWolBrgMJgl-zuS/exec';   
            // --- ELEMENT SELECTORS ---
            const mainPopup = document.getElementById('confirmationUserDetailsPopup');
            const openMainPopupButton = document.getElementById('openPopupForConfirmation');
            const closeMainPopupButton = document.getElementById('closeUserDetailsPopupButton');
            const finalPopup = document.getElementById('finalConfirmationPopup');
            const closeFinalPopupButton = document.getElementById('closeFinalConfirmationPopup');
            const finalMessageP = document.getElementById('final-confirmation-message');
            const usernameInput = document.getElementById('usernameInputPopup');
            const oldEmailInput = document.getElementById('oldEmailInputPopup');
            const newEmailInput = document.getElementById('newEmailInputPopup');
            const confirmButton = document.getElementById('confirmUserDetailsButton');
            const investmentCheckboxes = document.querySelectorAll('input[name="ip_package_details"]');
            const ip7Checkbox = document.getElementById('ip7-checkbox-details');
            const ip7Input = document.getElementById('ip7-custom-amount-details');
            const totalDisplaySpan = document.getElementById('total-investment-amount-details');
            const investmentError = document.getElementById('investmentErrorPopup');

            // --- HELPER FUNCTIONS ---
            const isEmailValid = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
            const closeMainPopup = () => { if (mainPopup) mainPopup.style.display = 'none'; document.body.style.overflow = 'auto'; };
            const closeFinalPopup = () => { if (finalPopup) finalPopup.style.display = 'none'; document.body.style.overflow = 'auto'; };

            // --- FORM UPDATE AND VALIDATION LOGIC ---
            const updateTotalInvestment = () => {
                let checkboxTotal = 0;
                investmentCheckboxes.forEach(cb => {
                    if (cb.checked) checkboxTotal += parseFloat(cb.value);
                });
                if (checkboxTotal >= 5000 && !ip7Checkbox.checked) {
                    investmentCheckboxes.forEach(cb => cb.checked = false); 
                    ip7Checkbox.checked = true;
                    ip7Input.value = checkboxTotal; 
                }
                let finalTotal = 0;
                if (ip7Checkbox.checked) {
                    ip7Input.disabled = false;
                    const currentValue = parseFloat(ip7Input.value);
                    if (isNaN(currentValue) || currentValue < 5000) ip7Input.value = 5000;
                    investmentCheckboxes.forEach(cb => cb.checked = false);
                    const ip7Value = parseFloat(ip7Input.value);
                    if (!isNaN(ip7Value)) finalTotal = ip7Value;
                } else {
                    ip7Input.disabled = true;
                    ip7Input.value = '';
                    finalTotal = checkboxTotal;
                }
                totalDisplaySpan.textContent = finalTotal;
                validateForm();
            };
            
            const validateForm = () => {
                let isFormValid = true;
                if (investmentError) investmentError.textContent = '';
                if (usernameInput.value.trim() === '') isFormValid = false;
                if (!isEmailValid(oldEmailInput.value.trim())) isFormValid = false;
                const newEmailValue = newEmailInput.value.trim();
                if (newEmailValue !== '' && !isEmailValid(newEmailValue)) isFormValid = false;
                const totalInvestment = parseFloat(totalDisplaySpan.textContent);
                if (isNaN(totalInvestment) || totalInvestment <= 0) isFormValid = false;
                if (ip7Checkbox.checked) {
                    const ip7Value = parseFloat(ip7Input.value);
                    if (isNaN(ip7Value) || ip7Value < 5000) {
                        isFormValid = false;
                        if (investmentError) investmentError.textContent = 'For LP7, the amount must be at least 5000 €.';
                    }
                }
                confirmButton.disabled = !isFormValid;
            };
            
            // --- EVENT LISTENERS ---
            document.getElementById('closePageButton')?.addEventListener('click', () => { window.location.href = 'prikaz_opcije_en.html' + window.location.search; });
            openMainPopupButton.addEventListener('click', () => { mainPopup.style.display = 'flex'; document.body.style.overflow = 'hidden'; validateForm(); });
            closeMainPopupButton.addEventListener('click', closeMainPopup);
            mainPopup.addEventListener('click', (event) => { if (event.target === mainPopup) closeMainPopup(); });
            closeFinalPopupButton.addEventListener('click', closeFinalPopup);
            finalPopup.addEventListener('click', (event) => { if (event.target === finalPopup) closeFinalPopup(); });
            [usernameInput, oldEmailInput, newEmailInput].forEach(input => input.addEventListener('input', validateForm));
            [...investmentCheckboxes, ip7Checkbox, ip7Input].forEach(el => el.addEventListener('input', updateTotalInvestment));
            document.querySelectorAll('.package-label').forEach(label => {
                label.addEventListener('click', (e) => {
                    const checkbox = document.getElementById(e.currentTarget.getAttribute('for'));
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        const changeEvent = new Event('change', { bubbles: true });
                        const inputEvent = new Event('input', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                        checkbox.dispatchEvent(inputEvent);
                    }
                });
            });

            // --- MAIN LOGIC FOR DATA SUBMISSION ---
            confirmButton.addEventListener('click', () => {
                if(confirmButton.disabled) return;
                
                closeMainPopup();
                finalMessageP.innerHTML = `<h4>Sending...</h4><p>Please wait.</p>`;
                finalPopup.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                let selectedPackages = [];
                document.querySelectorAll('input[name="ip_package_details"]:checked').forEach(cb => {
                    const packageName = cb.nextElementSibling.textContent;
                    const match = packageName.match(/\(LP\d+\)/);
                    selectedPackages.push(match ? match[0].replace(/[()]/g, '') : packageName.split(':')[0]);
                });
                if (document.getElementById('ip7-checkbox-details').checked) {
                    selectedPackages.push(`LP7 (${document.getElementById('ip7-custom-amount-details').value} €)`);
                }

                const dataToSend = new FormData();
                dataToSend.append('requestType', 'activeWithInvest');
                dataToSend.append('username', usernameInput.value.trim());
                dataToSend.append('oldEmail', oldEmailInput.value.trim());
                dataToSend.append('newEmail', newEmailInput.value.trim());
                dataToSend.append('selectedPackages', selectedPackages.length > 0 ? selectedPackages.join(', ') : "No package selected");
                dataToSend.append('totalAmount', totalDisplaySpan.textContent);
                
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: dataToSend
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        finalMessageP.innerHTML = 'Your decision has been recorded. We will contact you in a timely manner. Thank you.';
                    } else {
                        finalMessageP.innerHTML = 'An error occurred. Please try again.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    finalMessageP.innerHTML = 'A network error occurred. Please check your connection and try again.';
                })
                .finally(() => {
                setTimeout(() => {
                closeFinalPopup();
                window.location.href = 'index_en.html'; 
                }, 5000);
                });
            });

            // --- DYNAMIC TEXT AND ANIMATIONS ---
            const urlParams = new URLSearchParams(window.location.search);
            const paramIznos = urlParams.get('iznos') || '30';
            const paramValuta = urlParams.get('valuta') || 'usd';
            const currencySymbol = paramValuta.toLowerCase() === 'usd' ? '$' : '€';
            const reductionAmount = parseFloat(paramIznos) || 30;
            const sfbPoints = reductionAmount * 2;
            
            document.getElementById('dynamicStartPackageInfo').textContent = `${paramIznos} ${currencySymbol}`;
            document.getElementById('dynamicInvestmentReductionInfo').textContent = `The price of the License Package is reduced by ${reductionAmount} €.`;
            document.querySelectorAll('.dynamic-old-system-payment-amount').forEach(span => span.textContent = `${paramIznos} ${currencySymbol}`);
            document.querySelector('.dynamic-old-system-sf-points').textContent = sfbPoints;
            
            if (typeof gsap !== 'undefined') {
                gsap.from('.decision-content-box', { duration: 1, y: 50, opacity: 0, ease: 'power3.out', delay: 0.3 });
                gsap.from(['.main-greeting', '.intro-section > *', '.highlighted-choice-title', '.detailed-text > *', '.confirm-button-container'], 
                    { duration: 0.7, opacity: 0, y: 20, stagger: 0.1, ease: 'power2.out', delay: 0.6 }
                );
            }
        });
    </script>
    <!-- Background Animation Script -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('network-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let particles = [];
        const darkOptions = { particleColorRGB: '128, 255, 0', lineColorRGB: '170, 0, 255', particleAmount: 120, defaultRadius: 1.3, linkRadius: 150, particleSpeed: 0.25, lineWidth: 0.4 };
        const lightOptions = { particleColorRGB: '106, 27, 154', lineColorRGB: '171, 71, 188', particleAmount: 120, defaultRadius: 1.3, linkRadius: 150, particleSpeed: 0.25, lineWidth: 0.4 };
        let currentOptions = document.documentElement.classList.contains('light-mode') ? lightOptions : darkOptions;

        const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); };
        window.addEventListener('resize', resizeCanvas);

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.radius = currentOptions.defaultRadius;
                this.vx = (Math.random() - 0.5) * currentOptions.particleSpeed;
                this.vy = (Math.random() - 0.5) * currentOptions.particleSpeed;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${currentOptions.particleColorRGB}, 0.85)`; ctx.fill();
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x > canvas.width || this.x < 0) this.vx = -this.vx;
                if (this.y > canvas.height || this.y < 0) this.vy = -this.vy;
            }
        }

        const initParticles = () => {
            particles = [];
            for (let i = 0; i < currentOptions.particleAmount; i++) {
                particles.push(new Particle());
            }
        };

        const animate = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        };

        window.setAnimationTheme = (theme) => {
            currentOptions = (theme === 'light') ? lightOptions : darkOptions;
            if(canvas.width > 0) initParticles();
        };
        
        resizeCanvas();
        animate();
    });
    </script>
</body>
</html>